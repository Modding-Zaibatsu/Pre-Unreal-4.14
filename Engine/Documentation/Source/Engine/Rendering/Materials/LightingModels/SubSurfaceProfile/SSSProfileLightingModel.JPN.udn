Availability:Public
Title:サブサーフェス プロファイルのシェーディング モデル
Crumbs: %ROOT%, Engine, Engine/Rendering/Materials
Description:マテリアルで利用可能なサブサーフェス プロファイルのシェーディング モデルの説明と技術的な詳細。
Version:4.9

[TOC(start:2)]



リアルに見える人間の皮膚をレンダリングする機能は、最近のビデオ ゲーム エンジンでは必須です。このニーズに応えるために現在、アンリアル エンジン 4 (UE4) では、**サブサーフェス プロファイル** と呼ばれる皮膚やワックスのようなサーフェス用のシェーディング方法を提供しています。 
サブサーフェス プロファイルのシェーディング モデルは、サブサーフェス シェーディング モデルと類似のプロパティがあります。主な違いはどのようにレンダリングを行うかにあります。 
サブサーフェス プロファイルでは、これは人間の皮膚に見られる繊細なサブサーフェス エフェクトをよりよく表示しやすくする、スクリーン空間に基づいたレンダリング手法を採用しています。これにより、背面散乱が二次的なエフェクトとして耳などに稀に表れることがあります。
以下のドキュメントでは、サブサーフェス プロファイルがどのようなものであるか、各自の作業でどのように使用できるかについて説明します。 

[OBJECT:ComparisonSlider]
	[PARAM:before]
	![Not using SubsurfaceProfile](Results_1.png)(w:700 convert:false)
	[/PARAM]
	[PARAM:after]
	![Using SubsurfaceProfile](Results_2.png)(w:700 convert:false)
	[/PARAM]
[/OBJECT]


[Region:note]
3D スキャン ヘッドモデルの提供とご支援いただいた Lee Perry-Smith 氏と彼の会社 [Infinite Realities] (http://ir-ltd.net ) に深く感謝いたします。 
[/region]


## サブサーフェス プロファイルとは？

サブサーフェス スキャタリング プロファイルは、サブサーフェス スキャタリングがどのようにレンダリングされるかに関する情報を格納します。 
他のアクタと同様に **コンテンツ ブラウザ** で作成、共有、および格納できます。 
サブサーフェス スキャタリング プロファイルは、サブサーフェスでライトが散乱する距離、サブサーフェスの色、オブジェクトから出た後のライトのフォールオフ カラーなどアーティストが操作するデータを設定することで機能します。 
このデータをサブサーフェス マテリアルに適用して、サブサーフェスの見え方に影響を与えることができます。 
サブサーフェス プロファイルは、インタラクティブに微調整することもできます。つまり、編集結果を確認するためにマテリアルを再コンパイルする必要はありません。 




## サブサーフェス プロファイルの有効化、作成および使用 

マテリアルでサブサーフェス プロファイルを使用するには、最初にマテリアルの **[Details (詳細)]** パネルで **Shading Model** を **Subsurface Profile** に設定して、マテリアルがサブサーフェス プロファイルを使用できるようにします。 
また、**Subsurface Profile** 入力で別のサブサーフェス プロファイルを入力してマテリアルが使用するサブサーフェス プロファイルをオーバーライドすることもできます。

[REGION:tip]
サブサーフェス プロファイルのデフォルト設定は白色人種の皮膚に近いものです。これは、リアルに見える皮膚のひとつのコンポーネントにすぎないことに注意してください。 _テクスチャのベースカラーがサブサーフェス スキャタリング プロファイルに合うように常に確認してください。_
[/REGION]

![Enable SubsurfaceProfile](1.png)

サブサーフェス プロファイルは、マテリアル インスタンスでもオーバーライドできます。これを行うには、まず変更対象のマテリアル インスタンスを開く必要があります。 
次にマテリアル インスタンスの **[Details (詳細)]** セクションで **[Override Subsurface Profile (サーフェスプロファイルをオーバーライド)]** を有効にして、**Subsurface Profile** 入力で使用するサブサーフェス プロファイルを入れます。 

![](6.png)

サブサーフェス プロファイルを作成するには、まず **コンテンツ ブラウザ** 内で **右クリック** します。**[Materials & Textures]** オプション、そして **[Subsurface Profile]** オプションを選択します。 

![Create SubsurfaceProfile](2.png)

[region:note]
サブサーフェス プロファイルを指定しないと、白色人種の皮膚であるデフォルトのサブサーフェス プロファイルを使用します。
[/region] 


サブサーフェス プロファイルを編集するには、**コンテンツ ブラウザ** で **マウスの左ボタン** を **ダブルクリック** して開きます。 
一度開くと、サブサーフェス スキャタリング プロファイルの各プロパティを調整できます。これは、キーボードを使用して数字を入力するか、**マウスの左ボタン** を使用してカラーバー上で **クリック** してカラーピッカーに入れます。 


![Tweak SubsurfaceProfile](3.png)

* ** Scatter Radius: ** スキャタリングを行うワールド空間単位における距離です。 

* ** Subsurface Color： ** サブサーフェス カラーの色は、サブサーフェス エフェクトのウェイトとして使用できます。黒はサブサーフェス スキャタリングがないことを意味します。 
白はすべてのライティングがマテリアルに入り、周囲に散乱することを意味します。非グレイスケール値は、
どの色の寄与がサーフェスに入ってきて、より複雑な外観のシェーディングになるかをさらに制御します。 

* **Falloff Color: ** フォールオフ カラーは、ライトがマテリアルに入った後のマテリアルのスキャタリング カラーを定義します。 
スキャタリングが見えるエリアでシェーディングがより複雑に変化するようにしたければ、ここでは鮮明な色を使用しないようにします。

[region:note]
 計算全体ではエネルギーを節約しているため、スキャタリングでさらに多くのライトは作れないことを覚えておいてください (旧/他のサブサーフェス方式とは異なります)。
[/region]



## マテリアル入力チャンネル

スクリーン空間のサブサーフェス シェーディング プロファイルは、lit (ライティング有り) のシェーディング モードとあまり違いがありません。主な違いは、メタリック入力が再利用され、使用できないことです。  

**ベースカラーの入力:** ベースカラーの入力は通常通りディフューズ ライティングに使用します。スクリーン空間サブサーフェス スキャタリングは、色や明るさの変更は前提としておらず、近くのピクセルにライティングを再分配するだけです。そのため、追加のサブサーフェス スキャタリング カラーはありません。 
従って、マテリアルが特定のカラーでスキャタリングする場合、ベースカラーの一部として表現する必要があります。 
ベースカラーは、スキャタリングとディフューズ ライティングとの区別ができないような相当離れた場所からマテリアルを見たかのような最終的なカラーにします。 

[REGION:note]
 人間の皮膚は薄い淡いレイヤーとして、サーフェスの下ではより鮮やかな赤色で表示され、デフォルト カラーはこのように見えます。人間の皮膚の可視のスキャタリング距離は約 1.2 cm です。これはサブサーフェス プロファイルのデフォルト値でもあります。
[/region]

**メタリック入力:** メタリック入力チャンネルは、サブサーフェス プロファイルを使用する場合は利用できません。メタリック入力の GBuffer 空間はサブサーフェス プロファイル データに対応するように再利用されているからです。

**オパシティ入力:** オパシティ入力チャンネルは、サブサーフェス スキャタリングの寄与をマスクするために使用します。 
0 から 1 の範囲の値を使用すると、サブサーフェス スキャタリングの強度が異なりエリアの間で滑らかなトランジションを実現します。 
例えば、値 0 をオパシティ入力に入れると、サブサーフェス スキャタリングは無効になります。 
値 1 を入れると、サブサーフェス スキャタリングが最大限表示されます。 
サブサーフェス スキャタリングがどこで強くなるか、弱くなるかの制御を適切に行うために、マスク テクスチャを使用するのが最適です。  
1 により近い値すなわち白のマスク テクスチャのエリアでは、最強のサブサーフェス スキャタリング エフェクトになります。一方、 0 により近い値すなわち黒のマスク テクスチャのエリアでは、エフェクトは弱くなります。 
サブサーフェス カラーを調整すると、暗すぎるエリアがあれば補正します。より明るい色を使用するとサブサーフェス スキャタリングは増えることを覚えておいてください。 

ここでは、マスクを使用して1 つのマテリアルで 2 つのサーフェス タイプを どのようにレンダリングするかがわかります。トランジションはソフトでトライアングルの境界に制限されていないことに注意してください。

[REGION:lightbox]
[![](4.png)(w:920 convert:false)](4.png)
[/REGION]



## 技術的な詳細

現時点では、サブサーフェス スキャタリング プロファイルのシェーディング モデルは Lit (ライティング有り) (ランバート ディフューズ、スペキュラーの GGX、メタリックなし) とあまり変わりがありません。
 ほとんどの素晴らしい機能は、すべてのライティングが計算された後のポスト プロセスで実現します。 

[REGION:note]
サブサーフェス スキャタリング プロファイルは、[Jorge Jimenez 氏](http://www.iryoku.com/) の成果に基づいたものです。彼のウェブページで 3D 画像をよりリアルに見せるための役立つヒントをご覧ください。
[/REGION]

サブサーフェス マテリアル上のスペキュラに対応するために非スペキュラ (視点に依存しない) ライティングの寄与を分け、パフォーマンスを高めるためにダウンサンプリングします。 
ガウスぼかしと同様に、画像を 2 パス (分割可能なカーネルと想定) のポストプロセスでフィルタリングします。 
フィルターのカーネルはサブサーフェス スキャタリング プロファイルに依存し、これは、GBuffer (シーン毎に最高 255 アクティブ プロファイル) に格納されています。 
カーネルは色付けされたウェイトと特定のサンプル位置を持ち、プロファイルでスケーリングできます (cm 単位で定義)。 
最終段階で散乱光の寄与をフル解像度の画像と再結合します。このビューと、非視点依存のライティングを分けるために、シーンカラーのアルファチャンネルにウェイト付けの条件を格納します。 
この近似では、64 ビットのレンダリング ターゲット (r.SceneColorFormat を参照) を必要とし、ほとんどの場合で機能します。

これはスペキュラ (鏡面反射色) をうまく取り除きますが、スペキュラ ピクセルは彩度が減じられた非視点依存のカラーになります。これは、すべてのライティング パスに 2 つの 32 ビットのレンダリング ターゲットを使用することで改善できます。同じメモリ帯域幅を持ちますが、一部のハードウェアでは遅くなることがあります。これは変更対象です (コードの複雑度を追加)。

ここでは、ブラー適用前にスペキュラ(鏡面反射色) を取り除いた例をとりあげます。最終画像 (右端の画像) でスペキュラ反射が鮮明で滑らかなのがわかります。これが目標とするエフェクトです。

[REGION:lightbox]
[![](Good_Combination.png)(w:920 convert:false)](Good_Combination.png)
[/REGION]

ここでは、ブラー適用前にスペキュラ (鏡面反射色) が取り除かれなかった例をとりあげます。最終画像 (右端の画像) でスペキュラ反射に光沢がなく伸縮しているのがわかります。これは、このエフェクトをレンダリングする正しいやり方ではありません。  

[REGION:lightbox]
[![](Bad_Combination.png)(w:920 convert:false)](Bad_Combination.png)
[/REGION]

## スケーラビリティとコンソール コマンド

高品質なビジュアルと高いパフォーマンスとの間で適切なトレードオフを得るために使用できるスケーリングとパフォーマンスのコンソール コマンドがあります。 

**r.SSS.Scale**:ポストプロセスのパスを無効化、または簡単な実験のためにエフェクトをスケーリングすることができます。 

**r.SSS.SampleSet**:エフェクトの実行を速くするように使用するサンプルを減らすことができます。しかし、これはエフェクトが低品質になるか、レンダリングのアーティファクトが表示される可能性があることを意味します。

以下の画像は、システム内部を表しています。このビューは、**ShowFlag.VisualizeSSS 1** を使用して有効になります。

[REGION:lightbox]
[![](5.png)(w:920 convert:false)](5.png)
[/REGION]

サブサーフェス スキャタリング プロファイルのシェーディング モデルは、皮膚のレンダリングに関しては一歩進んだものですが、行えることにはいくつかの制限があります。
 _このシステムはますます進歩していくため、このリストは変更の可能性があることにご注意ください。_

* この機能は非ディファード (モバイル) レンダリング モードでは動作しません。
* 大きな画面でスキャタリング半径を設定すると、極端なライティング条件ではバンディングアーティファクトが表示されるかもしれません。
* 現在、ライトのバックスキャタリングはありません。 
* 現在、SSS マテリアルが非 SSS マテリアルによってオクルードされる場合、グレイのアウトラインが発生します。




## 謝辞

ヘッドモデルの提供とご支援いただいた Lee Perry-Smith 氏と彼の会社 [Infinite Realities](http://ir-ltd.net) に深く感謝いたします。 
また、この機能のもとになった実装をリリースいただいた [Jorge Jimenez 氏](http://www.iryoku.com/) にも深く感謝いたします。






