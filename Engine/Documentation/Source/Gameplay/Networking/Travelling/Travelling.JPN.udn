INTSourceChangelist:2713631
Availability:Public
Title:マルチプレイヤー ゲームの移動
Crumbs:%ROOT%, Gameplay, Gameplay/Networking
Description:マルチプレイヤー ゲーム内を移動する方法
Related:Gameplay/Networking/Server
Related:Gameplay/Framework
version:4.9

[TOC (start:2 end:3)]

## シームレスと非シームレス移動

UE4 には、移動方法が主に 2 種類あります。それは、シームレスと非シームレス移動です。主な違いは、シームレス移動はノンブロッキング操作であるのに対し、非シームレス移動はブロッキングコールで操作します。 

クライアントで非シームレス移動を実行すると、このクライアントはサーバーと非接続状態になってから、新しいマップのロード準備が整った同一サーバーと再接続します。

UE4 は、可能な限りマルチプレイヤー ゲームにシームレス移動の使用をお勧めします。大抵の場合はよりスムーズなゲーム体験となり、再接続のプロセス中に発生しがちな問題を回避できます。

非シームレス移動は、以下の 3 つの状況で行わなくてはいけません。
* マップの初回ロード時
* クライアントとして初めてサーバーと接続する時
* マルチプレイヤー ゲームを終了して新しいゲームを開始する時

移動は、`UEngine::Browse`、 `UWorld::ServerTravel` と `APlayerController::ClientTravel` の 3つの関数で操作します。使用すべき状況の判断は多少紛らわしいので、以下のガイドラインを判断基準にしてください。

### `UEngine::Browse`
* 新しいマップをロード中にハードリセットをするようなものです。
* 結果はかならず非シームレス移動になります。

* サーバーは目的マップへ移動する前に必ずクライアントと非接続状態になります。

* クライアントは現行サーバーと非接続になります。

* 専用サーバーは他のサーバーへ移動できません。そのためローカル (URLではなく) マップでなくてはいけません。

### `UWorld::ServerTravel`
* サーバーのみ。

* サーバーを新規ワールド / レベルへジャンプさせます。

* 接続中のすべてのクライアントはこれに従います。

* これは、マルチプレイヤー ゲームがマップからマップへ移動する方法です。サーバーはこの関数の呼び出しを管理します。

* サーバーは接続中のすべてのクライアントプレイヤーに `APlayerController::ClientTravel` を呼び出します。

### `APlayerController::ClientTravel`
* クライアントから呼び出されると、新規サーバーへ移動します。

* サーバーから呼び出されると、特定のクライアントに対して新しいマップへの移動を指示します (ただし現行サーバーへは接続されたままです)。

## シームレス移動の有効化

シームレス移動を有効にするには、トランジッションマップの設定が必要です。これは `UGameMapsSettings::TransitionMap` プロパティで設定します。デフォルトでは、このプロパティは空です。ゲームのこのプロパティを空のままで放置すると、トランジッションマップに空のマップが作成されます。 

トランジッション マップが存在する理由は、ワールドを常にロードした状態でなければいけないため (マップを保持)、新しいマップをロードする前に以前のマップを解放できないからです。マップが非常に大きい場合もあるため、古いマップと新しいマップを同時にメモリに保存することはお勧めしません。ここでトランジッションマップが必要になります。 

トランジッションマップを作成すると、現行マップからトランジッションマップへの移動が可能になります。そしてここから最終マップへ移動ができます。トランジッションマップはとても小さいため、現行および最終マップとオーバーラップ中に余分なオーバーヘッドは発生しません。

トランジッションマップを作成したら、 `AGameMode::bUseSeamlessTravel` を true に設定します。これでシームレス移動が機能します！

## シームレス移動のフロー

以下は、シームレス移動を実行時の一般的なフローです。
1. トランジッション レベルに持続するアクタにマークを入れます。
2. トランジッション レベルへ移動します。
3. 最終レベルに持続するアクタにマークを入れます。
4. 最終レベルへ移動します。

## シームレス移動中に持続するアクタ

シームレス移動を使用時に、現行レベルから新規レベルへ (持続する) アクタを引き継ぐことがあります。インベントリアイテムやプレイヤーなど、特定のアクタに実用的です。

デフォルトでこれらのアクタは自動的に持続します。
* `GameMode` アクタ (サーバーのみ)
	* さらなるアクタは `AGameMode::GetSeamlessTravelActorList` で追加
* すべてのコントローラーが有効な	`PlayerState` を保持 (サーバーのみ)
* すべての `PlayerControllers` (サーバーのみ)
* すべてのローカル `PlayerControllers` (サーバーとクライアント)
	* さらなるアクタは ローカルの `PlayerControllers` に呼び出した `APlayerController::GetSeamlessTravelActorList` で追加
